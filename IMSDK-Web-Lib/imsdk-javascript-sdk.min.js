(function(c,b){c.IMSDK={};var a={onInitialized:null,onDisConnected:null,onConnected:null,onConnectedError:null,onTextReceived:null,onImageReceived:null,onVoiceReceived:null,onSystemMsgReceived:null};c.IMSDK=function(e,f,o){if(e==null||typeof(e)!=="string"||e.length==0){return}b.extend(this,{VERSION:"0.0.1"});var g=b.extend({accepts:"",cache:false,crossDomain:true,dataType:"json",type:"POST",timeout:30000,contentType:"application/json",xhrFields:{withCredentials:true},beforeSend:function(u,t){b.extend(t.headers,{"x-rid":Date.now()})}},c.Global_Config);b.ajaxSetup(g);var h="http://";var s="/v1";var q=h+"rest.imsdk.im"+s;b.extend(this,a,o);var i=false;var p=false;this.current={cid:null,photo:null,nick_name:null};var n=this;this.app_key=e;var k=q;var l={REGISTER:k+"/reg",LOGIN:k+"/login",LOGOUT:k+"/logout",GET_USER:k+"/user/{cid}",FRIENDS:k+"/friends",MSG:k+"/msg",NEW_MSG:k+"/onlinemsg"};n.token=f;this.setLogging=function(t){i=t==true?true:false};this.register=function(t,v,u){(v&&typeof(v)=="function")||(v=function(){});(u&&typeof(u)=="function")||(u=function(){});if(p){u.call(n,-2,"重复的登录，要更换登录用户，请先登录");return}var w=b.extend(t,{token:n.token,app_key:n.app_key,nick_name:"",photo:""});r(this,l.REGISTER,w,function(x){p=true;this.current.cid=x;d.call(this);v.call(this,x)},u)};this.login=function(x,t,u,v){(u&&typeof(u)=="function")||(u=function(){});(v&&typeof(v)=="function")||(v=function(){});if(p){v.call(this,-2,"重复的登录，要更换登录用户，请先登出");return}var w={app_key:this.app_key,cid:x,password:t};r(this,l.LOGIN,w,function(y){p=true;this.current.cid=y;d.call(this);u.call(this,y)},v)};this.logout=function(u,t){(u&&typeof(u)=="function")||(u=function(){});(t&&typeof(t)=="function")||(t=function(){});r(this,l.LOGOUT,{},function(v){p=false;b.extend(this.current,{});u.call(this,v)},t)};this.getStatus=function(){return p};this.getUserInfo=function(u){var t=l.GET_USER.replace("{user}",this.current.cid);return m(this,t,{})};this.getFriends=function(u){var t=l.FRIENDS;return m(this,t,{})};this.sendUserMsg=function(t,v,u){(v&&typeof(v)=="function")||(v=function(){});(u&&typeof(u)=="function")||(u=function(){});t.target_type="user";r(this,l.MSG,t,v,u)};this.sendTeamMsg=function(t,v,u){(v&&typeof(v)=="function")||(v=function(){});(u&&typeof(u)=="function")||(u=function(){});t.target_type="team";r(this,l.MSG,t,v,u)};var j=function(u,v,t){r(this,l.MSG,u,v,t)};var r=function(t,u,x,w,v){b.ajax({url:u,data:c.IMSDK.ParamsBuilder.buildPostData(x),context:t||this,complete:function(y,B){try{var z=y.responseJSON;if(z.status==0){w.call(n,z.data,x)}else{v.call(n,z.status,z.error_msg,x)}}catch(A){v.call(n,-1,A)}}})};var m=function(u,v,w){var t=null;b.ajax({url:v,data:w,type:"GET",async:false,context:u||this,complete:function(x,A){try{var y=x.responseJSON;if(y.status==0){t={code:0,data:y.data}}else{t={code:y.status,error_msg:y.error_msg}}}catch(z){t={code:-1,error_msg:z}}}});return t};var d=function(){if(!p){n.onDisConnected&&typeof(n.onDisConnected)==="function"&&n.onDisConnected.call(n);return}var t=l.NEW_MSG;b.ajax({url:t,data:{},context:n,complete:function(w,z){var u=true;try{var x=w.responseJSON;switch(x.status){case 0:var v=x.data;b.each(v,function(B,D){var C=D.type;var A=D.data;switch(C){case"p2p":b.each(A,function(E,F){switch(F.msg_type){case"voice":n.onVoiceReceived&&typeof(n.onVoiceReceived)==="function"&&n.onVoiceReceived.call(n,F);break;case"img":n.onImageReceived&&typeof(n.onImageReceived)==="function"&&n.onImageReceived.call(n,F);break;default:n.onTextReceived&&typeof(n.onTextReceived)==="function"&&n.onTextReceived.call(n,F);break}})}});break;case 4:p=false;break;case 1:case 2:case 3:console.error("get msg error - [ code:"+x.status+" msg:"+x.error_msg+"]");u=false;break;default:console.error("get msg error - [ code:"+x.status+" msg:"+x.error_msg+"]");break}}catch(y){console.warn("get msg exception - "+y)}if(u){d.call(n)}}})};this.onInitialized&&typeof(this.onInitialized)==="function"&&this.onInitialized({app_key:this.app_key})};c.IMSDK.ParamsBuilder=function(){return{buildPostData:function(d){if(typeof(d)!=="object"){return null}return JSON.stringify(d)}}}()}(window,jQuery));
